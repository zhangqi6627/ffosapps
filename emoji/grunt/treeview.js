/* global module:false */
module.exports = function( grunt ){

  var jadedatas = grunt.config.get('jadedatas');

  grunt.registerTask( 'treeview', function(){

    var treeJSON,
        jadeVars;

    // register a task te delete the tree file once its used
    grunt.registerTask( 'cleanTreeJSON', 'remove the tree.json file generated by grunt-tree', function(){
      grunt.file.delete( 'tree.json' );
    } );

    grunt.registerTask('readJSON', "get the treeview JSON", function(){
      treeJSON = grunt.file.readJSON("tree.json");

      jadeVars = grunt.util._.extend({
        projectName: "<%= package.title %>",
        tree: treeJSON,
        treeFile: "index"
      }, jadedatas );

      grunt.config.set('jade.tree', {
        files: {
          "<%= build %>/app/index.html": grunt.file.exists("src/app/templates/layouts/tree.jade") ? "src/app/templates/layouts/tree.jade" : "tree.jade"
        },
        options: {
          data: jadeVars,
          pretty: true,
          selfClose: true,
          compileDebug: false
        }
      });

    });

    grunt.task.run( [
      'tree',
      'readJSON',
      'jade:tree',
      'cleanTreeJSON'
    ] );

  });

};
